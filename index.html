<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ã˜ã‚ã˜ã‚é‡‘å¤§</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      height: 100vh;
    }

    iframe {
      width: 100%;
      height: 100%;
      border: 0;
    }

    .header {
      position: fixed;
      top: 0px;
      left: 0px;
      z-index: 10;
      background-color: lemonchiffon;
      width: 100%;


    }

    .header2 {

      display: flex;
    }

    .linkurl {
      margin-left: auto;
    }

    #flash {
      display: inline-block;
      width: 100px;
      height: 40px;
      cursor: pointer;
      background-color: skyblue;
      text-decoration: none;
      text-align: center;
      line-height: 50px;
      border-radius: 6px
    }



    .dataContent {
      margin-left: 30px;
      padding-top: 120px;
      display: block;
    }

    .dataNone {
      display: none;
    }

    .clkBtn {
      cursor: pointer;
      user-select: none;
    }

    .divFlex {
      display: flex;
    }

    .sheetSelect {
      padding-top: 0px;
    }

    .speed {
      padding-top: 0px;
    }

    .STOPMP3 {
      margin-left: 10px
    }

    .classGazou {
      display: inline-block;
      width: 50px;
      height: 50px;
      text-decoration: none;
      background-image: linear-gradient(to bottom,
          rgba(255, 255, 0, 0.5),
          rgba(0, 0, 255, 0.5));
    }

    .classSite {
      display: inline-block;
      width: 50px;
      height: 20px;
      text-decoration: none;
      cursor: pointer;
    }

    .wordcard-button {
      margin-left: auto;
      padding: 8px 16px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      display: inline-block;
      margin-right: 10px;
    }

    .wordcard-button:hover {
      background-color: #45a049;
    }

    .loading {
      position: fixed;
      top: 100px;
      left: 100px;
      z-index: 99;
      content: '';
      display: block;
      margin: auto;
      width: 300px;
      border: 4px solid #ccc;
      border-right-color: #0AC;
      border-radius: 100px;
      width: 30px;
      height: 30px;
      background-color: white;
      animation: rotation 0.6s linear infinite;
    }

    @keyframes rotation {
      from {
        transform: rotate(0);
      }

      to {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body>
  <div id="kurukuru" class="loading"></div>
  <div class="header">



    <div class="header2">
      <div class="logo">
        <h3>
          å®Ÿé¨“mp3 ä¸­å›½èªã§ä¼ãˆã‚ˆã†
        </h3>
      </div>
      <div class="linkurl">
        <!-- <a href="https://script.google.com/macros/s/AKfycbxit3_KIGgWFaldwTaRh6bL9RfomVZkB4fuwpqemZ3NSP1eSOxfRK0U9YFxqZQZ7NSr/exec"
          class="wordcard-button" target="_blank">å˜èªã‚«ãƒ¼ãƒ‰</a> -->


      </div>


    </div>
    <div class="divFlex">
      <div class="sheetSelect">

        <label for="sheet-select">é¸æŠï¼š</label><select id="sheet-select" name="sheetSelect"></select>
      </div>
      <div class="speed">
        <label for="speech-Speed">ã€€ã‚¹ãƒ”ãƒ¼ãƒ‰:</label>

        <select name="speechSpeed" id="speech-Speed">
          <option value="1.0">1.0</option>
          <option value="0.9">0.9</option>
          <option value="0.8">0.8</option>
          <option value="0.7">0.7</option>
          <option value="0.6">0.6</option>
          <option value="0.5">0.5</option>
          <option value="1.1">1.1</option>
          <option value="1.2">1.2</option>
          <option value="1.3">1.3</option>
          <option value="1.4">1.4</option>
          <option value="1.5">1.5</option>
          <option value="1.6">1.6</option>
          <option value="1.7">1.7</option>
          <option value="1.8">1.8</option>
          <option value="1.9">1.9</option>
          <option value="2.0">2.0</option>

        </select>
      </div>
      <div class="STOPMP3">
        <button id="stopMP3" onclick="fncStopMP3(this)">MP3 åœæ­¢</button>
      </div>




    </div>
  </div>
  <div id="main">
    <div id="container">

    </div>


  </div>




  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

  <script>
    // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã€€åˆ—ã€€å®šæ•°å®šç¾©
    const END_POINT = "https://script.google.com/macros/s/AKfycbwX6jP1Tc2GYmoP8w8Av5gaf2AghVHSm-Ljq7Ef1ma_VAhxWo5lsiubucOupZzGt7BfiQ/exec";
    // ãƒ‡ãƒã‚¤ã‚¹ã®ç¨®é¡ã‚’åˆ¤åˆ¥
    const userAgent = navigator.userAgent;

    let isIphone = false;
    if (userAgent.includes("iPhone")) {
      isIphone = true;
      console.log("ã“ã®ãƒ‡ãƒã‚¤ã‚¹ã¯iPhoneã§ã™");
    } else if (userAgent.includes("Android")) {
      console.log("ã“ã®ãƒ‡ãƒã‚¤ã‚¹ã¯Androidã§ã™");
    } else if (userAgent.includes("Windows") || userAgent.includes("Mac")) {
      console.log("ã“ã®ãƒ‡ãƒã‚¤ã‚¹ã¯PCã§ã™");
    } else {
      console.log("ä¸æ˜ãªãƒ‡ãƒã‚¤ã‚¹ã§ã™");
    }
    console.log("userAgent:", userAgent);

    // 2025-03-19
    let voices = [];
    // åˆæœŸéŸ³å£°ãƒªã‚¹ãƒˆã®å–å¾—
    voices = speechSynthesis.getVoices();
    // éŸ³å£°ãƒªã‚¹ãƒˆãŒå–å¾—ã§ããªã„å ´åˆã¯ã€éŸ³å£°ãƒªã‚¹ãƒˆãŒå–å¾—ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã¾ã§å¾…æ©Ÿ
    //   2025-03-19
    let sheetIndex;  // ç¾åœ¨å‡¦ç†ä¸­ã®ã‚·ãƒ¼ãƒˆã®index
    let saveAllDatas;
    let sheetDatas;
    let mp3Start = false;
    const bgColorNothing = '#ffffff';
    const bgColorGazou = '#000000';
    const bgColorSite = '#00000a';
    const bgColorMP3 = '#fffffb';  //2025-04-17
    const bgColorPinyin = '#fffffa';
    const bgColorJapanese = '#fce5cd'; // 2025-05-08

    const sheetSelector = document.getElementById("sheet-select");
    let container = document.getElementById('container');
    let kurukuru = document.getElementById('kurukuru');
    let classSTOPMP3 = document.querySelector('.STOPMP3');
    let stopMP3 = document.getElementById('stopMP3');

    classSTOPMP3.style.display = 'none';
    let sound = new Audio();
    //  mp3ãƒ•ã‚¡ã‚¤ãƒ«ã®å†ç”ŸãŒå®Œäº†ã—ãŸã¨ãã«å‘¼ã³å‡ºã•ã‚Œã‚‹ã€‚
    sound.addEventListener("ended", () => {
      mp3Start = false;
      classSTOPMP3.style.display = 'none';

    });

    getFromGAS();//èµ·å‹•æ™‚ã®ãƒ‡ãƒ¼ã‚¿å–å¾—

    //----------- ä»¥ä¸‹ã€é–¢æ•°å®šç¾©--------------------------

    function getFromGAS() {

      $.ajax({
        type: "GET",
        url: END_POINT,
        // data: { sheetNo: SHEET_NO }

      }).done((result) => {        // æˆåŠŸã—ãŸæ™‚ã®å‡¦ç†
        console.log("get done:" + result);
        setSheetNames(JSON.parse(result)[0]);

        // getFromGAS(1);
        sheetDatas = JSON.parse(result);

        renderSheetDatas(sheetDatas);

        kurukuru.remove();

        iniCSSSet();
      }).fail((error) => {  // å¤±æ•—ã—ãŸæ™‚ã®å‡¦ç†
        alert('Error:' + JSON.stringify(error));

      }).always((data) => {// å¸¸ã«ã‚„ã‚‹å‡¦ç†
        // do something
        // enableControlElements();
      });
    }
    function setSheetNames(sheetNamesArray) {
      sheetSelector.innerHTML = "";
      document.createElement('option')
      sheetNamesArray.forEach((sheetName, index) => {
        let option = document.createElement('option');
        option.setAttribute('value', index + 1);
        option.innerHTML = sheetName;
        sheetSelector.appendChild(option);
      });
    }

    var tdOLD;//2023/04/27è¿½åŠ 
    let tdOLDColor;  // 20231223 è¿½åŠ 

    // 23-07-04 ã‚·ãƒ¼ãƒˆãŒå¤‰æ›´ã•ã‚ŒãŸã¨ãã«å®Ÿè¡Œã•ã‚Œã‚‹ã€‚----------------------

    let select = document.querySelector('[name="sheetSelect"]');

    select.onchange = event => {
      var selIndex = select.selectedIndex;
      sheetIndex = selIndex;
      console.log(select.selectedIndex);
      var classElement = document.getElementsByClassName('dataContent');
      for (let i = 0; i < classElement.length; i++) {
        if (selIndex === i) {

          classElement[i].classList.remove("dataNone");
        } else {
          classElement[i].classList.add("dataNone");

        }

      }
    }
    // 

    // mp3
    async function speakMp3(param1) {
      
    
      if (mp3Start) {
        return;
      }

      mp3Start = true;

      classSTOPMP3.style.display = 'block';
      let mp3Tab = param1.split(',');
      for (const d of mp3Tab) {
        console.log(d);
        // éŸ³å£°ã®å†ç”ŸãŒçµ‚ã‚ã‚‹ã¾ã§ãƒ«ãƒ¼ãƒ—ã‚’å›ã•ãªã„ã‚ˆã†ã«æ­¢ã‚ã¦ãŠã
        await new Promise((resolve) => {
          // const sound = new Audio("mp3Files/" + d);
          sound = new Audio("mp3Files/" + d);
          sound.play();
          sound.addEventListener('ended', async () => {
            // éŸ³å£°çµ‚äº†å¾Œã«ã„ããªã‚Šæ¬¡ã®éŸ³å£°ãŒå†ç”Ÿã•ã‚Œã¦ã‚‹ã¨é•å’Œæ„ŸãŒã™ã”ã„ã®ã§ã¡ã‚‡ã£ã¨ã‚¹ãƒªãƒ¼ãƒ—ã‹ã‘ã‚‹
            // await sleep(100);
            resolve();
          }, { once: true });
        });
      }
      sound.pause();
      classSTOPMP3.style.display = 'none';
      mp3Start = false;

    }


    // console.log(`mp3Tab:${mp3Tab}`);
    // let i;
    // for (i = 0; i < mp3Tab.length; i++) {
    //   let mp3File = 'mp3Files/' + mp3Tab[i];
    //   console.log(`mp3File:${mp3File}`);
    //   music.src = mp3File;
    //   music.play();
    //   console.log("Playing audio");

    // }
      
        
        

    
    // 
    function speakJapanes(param1) {
      if (mp3Start) {
        return;
      }




      // if (param1 instanceof HTMLTableCellElement) {
      const td = param1;
      //2023/04/27 è¿½åŠ ã€€èƒŒæ™¯è‰²
      if (tdOLD === undefined) {
        tdOLD = param1;
        tdOLDColor = tdOLD.style.backgroundColor;
      } else {
        tdOLD.style.backgroundColor = tdOLDColor;
        tdOLD = param1;
        tdOLDColor = tdOLD.style.backgroundColor;

      }
      //2023/04/27 è¿½åŠ ã€€èƒŒæ™¯è‰²
      td.style.backgroundColor = 'cyan';//2023/04/27è¿½åŠ ã€€èƒŒæ™¯è‰²ã€€å¤‰æ›´å¯èƒ½
      var uttr = new SpeechSynthesisUtterance(td.textContent);
      uttr.lang = "ja-JP"
      // åˆ©ç”¨å¯èƒ½ãªéŸ³å£°ã‚’ç¢ºèª 2025-03-19
      // const voices = speechSynthesis.getVoices();
      // const japaneseVoice = getJapaneseVoice();

      // if (japaneseVoice) {
      //   uttr.voice = japaneseVoice;
      // } else {
      //   console.warn('Japanese voice not found, using default voice.');
      // }
      // // 2025-03-19
      uttr.rate = speakSpeedRate();
      speechSynthesis.cancel();
      speechSynthesis.speak(uttr);

    }
    //
    function speakData(param1, param2) {
      if (mp3Start) {
        return;
      }



      // if (param1 instanceof HTMLTableCellElement) {
      const td = param1;
      //2023/04/27 è¿½åŠ ã€€èƒŒæ™¯è‰²
      if (tdOLD === undefined) {
        tdOLD = param1;
        tdOLDColor = tdOLD.style.backgroundColor;
      } else {
        tdOLD.style.backgroundColor = tdOLDColor;
        tdOLD = param1;
        tdOLDColor = tdOLD.style.backgroundColor;

      }
      //2023/04/27 è¿½åŠ ã€€èƒŒæ™¯è‰²
      td.style.backgroundColor = 'cyan';//2023/04/27è¿½åŠ ã€€èƒŒæ™¯è‰²ã€€å¤‰æ›´å¯èƒ½
      var uttr = new SpeechSynthesisUtterance(td.textContent);
      uttr.lang = "zh-CN"
      // åˆ©ç”¨å¯èƒ½ãªéŸ³å£°ã‚’ç¢ºèª 2025-03-19
      const voices = speechSynthesis.getVoices();
      const chineseVoice = getChineseVoice();

      if (chineseVoice) {
        uttr.voice = chineseVoice;
      } else {
        console.warn('Chinese voice not found, using default voice.');
      }
      // 2025-03-19
      uttr.rate = speakSpeedRate();
      speechSynthesis.cancel();
      speechSynthesis.speak(uttr);

      // }

    }
    // 2025-03-19
    function getChineseVoice() {
      if (voices.length === 0) {
        voices = speechSynthesis.getVoices();
      }
      return voices.find(voice => voice.lang === 'zh-CN');
    }

    // éŸ³å£°ãƒªã‚¹ãƒˆãŒæ›´æ–°ã•ã‚ŒãŸã¨ãã«å†å–å¾—
    speechSynthesis.onvoiceschanged = function () {
      voices = speechSynthesis.getVoices();
    };
    // 2025-03-19
    function renderSheetDatas(sheetDatas) {

      let div, table, tr, td, tbody, atag;
      for (let i = 1; i < sheetDatas.length; i++) {
        div = document.createElement('div');
        div.setAttribute('class', 'dataContent');

        container.appendChild(div);
        //
        table = document.createElement('table');
        table.setAttribute('border', '1');
        div.appendChild(table);
        tbody = document.createElement('tbody');
        table.appendChild(tbody);
        for (let j = 0; j < sheetDatas[i].length; j++) {
          tr = document.createElement('tr');
          let strContent;
          let strName;
          let strBgColor;
          let splitURL;
          let siteComment;
          let siteAddress;
          for (let k = 0; k < sheetDatas[i][j].length; k++) {
            td = document.createElement('td');
            if (sheetDatas[i][j][k] === '') {
              td.textContent = '    ';
            } else {

              strContent = sheetDatas[i][j][k];
              [strName, strBgColor] = cnvString(strContent);
              switch (strBgColor) {
                case bgColorGazou:



                  splitURL = strName.split("/");
                  fileURL = "https://lh3.googleusercontent.com/d/" + splitURL[5];
                  atag = document.createElement('a');

                  let gazouURL0 = fileURL;
                  atag.setAttribute('href', gazouURL0);
                  atag.setAttribute('class', 'classGazou');
                  atag.setAttribute('target', '_blank');

                  let img = document.createElement('img');


                  img.setAttribute('src', gazouURL0);
                  img.setAttribute('class', 'classGazou');
                  // atag.setAttribute('target', '_blank');


                  atag.appendChild(img);
                  td.appendChild(atag);
                  break;
                case bgColorSite:
                  // let siteComment;
                  // let siteAddress;
                  [siteComment, siteAddress] = cnVSiteString(strName);

                  atag = document.createElement('a');


                  atag.setAttribute('href', siteAddress);
                  atag.setAttribute('class', 'classSite');
                  atag.setAttribute('target', '_blank');
                  atag.innerHTML = siteComment;
                  // atag.innerHTML = 'å‚è€ƒã‚µã‚¤ãƒˆ';

                  td.appendChild(atag);
                  break;
                case bgColorPinyin:

                  td.textContent = strName.substring(0, 1).toUpperCase() + strName.substring(1);
                  break;
                case bgColorMP3:
                  [siteComment, mp3File] = cnVMp3String(strName);
                  let mp3FileX = mp3File;
                  console.log(mp3File);
                  td.textContent = siteComment;
                  td.setAttribute('onclick', `speakMp3('${mp3FileX}')`);


                  td.setAttribute('class', 'clkBtn');
                  td.style.backgroundColor = "#fffacd";
                  break;
                case bgColorJapanese:
                  td.textContent = strName;
                  td.setAttribute('onclick', 'speakJapanes(this)');
                  td.setAttribute('class', 'clkBtn');
                  td.style.backgroundColor = strBgColor;
                  break
                case bgColorNothing:
                  td.textContent = strName;
                  break;
                default:
                  td.textContent = strName;
                  td.setAttribute('onclick', 'speakData(this)');
                  td.setAttribute('class', 'clkBtn');
                  td.style.backgroundColor = strBgColor;






              }
            }
            tr.appendChild(td);
          }



          tbody.appendChild(tr);
        }

      }

      //


    }

    //
    function cnvString(strContent) {
      let strName;
      let strBgColor;
      [strName, strBgColor] = strContent.split('é«˜*æ²¢');
      return [strName, strBgColor];
    }
    // 
    function cnVSiteString(strName) {
      let siteComment;
      let siteAddress;
      let comment2 = strName.split('/http');
      if (comment2.length === 1) {
        siteComment = 'å‚è€ƒã‚µã‚¤ãƒˆ';
        siteAddress = strName;

      } else {
        let comment3 = strName.split('/');
        siteComment = comment3[0];

        siteAddress = strName.substring(comment3[0].length + 1, strName.length);

      }
      return [siteComment, siteAddress];

    }
    //
    function cnVMp3String(strName) {
      let siteComment;
      let mp3File;
      mp3File = strName.split('/');
      if (mp3File.length === 1) {
        siteComment = 'MP3ğŸ”Š';
        mp3File = strName;
      } else {

        [siteComment, mp3File] = strName.split('/');
      }

      return [siteComment, mp3File];

    }
    // ã‚¤ãƒ‹ã‚·ãƒ£ãƒ«ã€€CSS ã‚»ãƒƒãƒˆã€€ã€€æœ€åˆã®ã‚·ãƒ¼ãƒˆã‚’ã‚¤ãƒ‹ã‚·ãƒ£ãƒ«ç”»é¢ã«ã™ã‚‹ã€‚
    function iniCSSSet() {
      sheetIndex = 0;
      var classElement = document.getElementsByClassName('dataContent');
      for (let i = 1; i < classElement.length; i++) {
        classElement[i].classList.add("dataNone");
      }

    }
    // speak speed èª¿æ•´ 2023-07-04
    function speakSpeedRate() {

      let select = document.querySelector('[name="speechSpeed"]');

      var rate = parseFloat(select.selectedOptions[0].value);
      return rate;

    }
    // mp3ãƒ•ã‚¡ã‚¤ãƒ«ã€€å†ç”Ÿã‚¹ãƒˆãƒƒãƒ—
    function fncStopMP3(parta1) {

      sound.pause();
      classSTOPMP3.style.display = 'none';
      mp3Start = false;

    }
  </script>

</body>

</html>